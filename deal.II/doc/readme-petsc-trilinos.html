<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
       "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <title>The deal.II Readme on interfacing to PETSc and Trilinos</title>
  <link href="screen.css" rel="StyleSheet">
  <meta name="author" content="the deal.II authors <authors @ dealii.org>">
  <meta name="copyright" content="Copyright (C) 2008, 2009, 2010, 2011 by the deal.II authors">
  <meta name="date" content="$Date: 2008-10-14 05:36:48 -0500 (Tue, 14 Oct 2008) $">
  <meta name="svn_id" content="$Id: readme.html 17202 2008-10-14 10:36:48Z heister $">
  <meta name="keywords" content="deal.II">
</head>

<body>


    <h1>Interfacing <acronym>deal.II</acronym> to PETSc and Trilinos</h1>

    <h3>About PETSc, Trilinos, and the <acronym>deal.II</acronym>
    interfaces</h3>

    <p>
      <acronym>deal.II</acronym> can interface to the <a
      href="http://www.mcs.anl.gov/petsc/" target="_top">PETSc</a> and
      <a href="http://trilinos.sandia.gov" target="_top">Trilinos</a> software
      libraries. Both of these libraries provide lots of functions for linear
      algebra, among other things, for example implementations of a variety of
      linear solvers, as well as various different sparse and dense matrix and
      vector formats. Trilinos also has many subpackages that deal with
      problems that go far beyond linear algebra, for example nonlinear
      solvers, automatic differentiation packages, uncertainty propagation
      engines, etc. Of particular interest to deal.II is their ability to
      provide this functionality both on sequential and parallel (using MPI)
      computers. PETSc is written in C; Trilinos is written in C++ and can be
      considered to be a more modern version of PETSc though both packages are
      under continuing development at their respective national laboratories.
      </p>

      <p>
      <acronym>deal.II</acronym> has wrapper classes to the linear algebra
      parts of both packages that provide almost the
      same interfaces as the built-in <acronym>deal.II</acronym> linear
      algebra classes. We use these interfaces for parallel computations based
      on MPI since the native deal.II linear algebra classes lack this ability.
      </p>

      <h3>Configuring the interfaces to PETSc and Trilinos</h3>

      <p>
      The use of PETSc and Trilinos is optional. To use the wrapper classes,
      you first have to install these packages and
      point <acronym>deal.II</acronym>'s <code>./configure</code> to the
      installation directories. This happens in similar ways for the two
      packages:
      </p>

      <h5>PETSc</h5>

      <p>
      PETSc usually requires you to set the
      environment variables <code>PETSC_DIR</code> and <code>PETSC_ARCH</code>
      to a path to PETSc and denoting the architecture for which PETSc is
      compiled. If these environment variables are set, then
      <acronym>deal.II</acronym> will pick them up during
      configuration, and store them. It will then also recognize that
      PETSc shall be used, and enable the wrapper classes.
      </p>

      <p>
      Alternatively, the <code>--with-petsc=DIR</code> and
      <code>--with-petsc-arch=ARCH</code> switches to
      <code>./configure</code> can be used to override the values
      of <code>PETSC_DIR</code> and <code>PETSC_ARCH</code> or if
      these environment variables are not set at all. If you do have a
      PETSc installation and have set the <code>PETSC_DIR</code> and
      <code>PETSC_ARCH</code> environment variables but do not wish
      <acronym>deal.II</acronym> to be configured for PETSc use, you
      should specify <code>--with-petsc=no</code> as a flag during
      configuration.
      </p>

      <p>
      Note that in order to use PETSc with <acronym>deal.II</acronym>
      with the current version of <acronym>deal.II</acronym> you will
      need to have at least PETSc version 2.3.0 installed, earlier
      releases are no longer supported. <acronym>deal.II</acronym>
      version 6.2 has been tested up to PETSc release 3.0.0-p11.
      </p>

      <p>
      There is an additional caveat: PETSc appears not to co-operate
      well when using threads and some programs crash when deal.II is
      compiled in its usual mode supporting multithreading. If you see
      this sort of behavior, we recommend to try disabling
      multithreading upon configuration of <acronym>deal.II</acronym>
      using the
      <code>--disable-threads</code> switch to <code>./configure</code>.
      </p>

      <p>
      Installing both PETSc and deal.II together can be a bit of a
      challenge. A good summary of the relevant steps can be found on
      the <a href="http://dealii.sourceforge.net/index.php?title=Deal.II_Questions_and_Answers"
      target="_top">Frequently Asked Questions</a> page.
      </p>

      <h5>Trilinos</h5>

      <p>
      As above, set the <code>TRILINOS_DIR</code>
      environment variable to the path to an existing Trilinos installation,
      or use the <code>--with-trilinos=/path/to/trilinos</code> switch of
      the deal.II <code>./configure</code> script. It should point to the path
      of which the include and lib directories are subdirs. The Trilinos
      installation needs to provide the same kind of libraries that
      <acronym>deal.II</acronym> is configured for, i.e. if you want deal.II
      to use shared libraries, then Trilinos needs to use shared libraries as
      well.
      </p>

      <p>
      <acronym>deal.II</acronym> and its tutorial programs use several of the
      Trilinos sub-packages.
      </p>

      <h6>Trilinos up to and including version 9.0.x</h6>

      <p>
      Up to version 9.0, Trilinos was configured and built using autoconf and
      related tools. Configuring and building Trilinos with a sequence of
      commands like the following should do the trick:
      <code>
      <pre>
cd trilinos-9.0.2
mkdir build
cd build
../configure --enable-shared \
      --with-cflags=-fPIC --with-cxxflags=-fPIC --with-fflags=-fPIC \
      --enable-thyra --enable-stratimikos --enable-rtop --enable-teuchos \
      --enable-sacado --enable-ml --enable-ifpack --enable-epetra \
      --enable-belos --enable-aztecoo --enable-amesos \
      --prefix=/home/bangerth/bin/trilinos-9.0.2
make
make install
      </pre>
      </code>
      Obviously the path names in the first line and at the end of the
      configure line need to be adjusted.
      </p>

      <h6>Trilinos starting with version 10.0</h6>

      <p style="color: red">
      Note: Trilinos versions 10.6.0 to 10.6.2 are not compatible with
      deal.II. There are subtle bugs related to parallel matrices and vectors.
      </p>

      <p>
      Starting with version 10.0, Trilinos uses cmake to configure and
      build. This is a bit cumbersome because you first have to install a
      version of cmake that is at least a cmake 2.8 prerelease, and then enter
      the following slightly longish set of commands:
      <code>
      <pre>
cd trilinos-10.0.2
mkdir build
cd build

cmake -D Trilinos_ENABLE_OPTIONAL_PACKAGES:BOOL=ON \
      -D Trilinos_ENABLE_Sacado:BOOL=ON \
      -D Trilinos_ENABLE_Stratimikos:BOOL=ON \
      -D CMAKE_BUILD_TYPE:STRING=RELEASE \
      -D CMAKE_CXX_FLAGS:STRING="-g -O3" \
      -D CMAKE_C_FLAGS:STRING="-g -O3" \
      -D CMAKE_FORTRAN_FLAGS:STRING="-g -O5" \
      -D Trilinos_EXTRA_LINK_FLAGS:STRING="-lgfortran" \
      -D CMAKE_VERBOSE_MAKEFILE:BOOL=FALSE \
      -D Trilinos_VERBOSE_CONFIGURE:BOOL=FALSE \
      -D TPL_ENABLE_MPI:BOOL=OFF \
      -D CMAKE_INSTALL_PREFIX:PATH=/w/bangerth/share/x86_64/trilinos-10.4.0 \
      -D BUILD_SHARED_LIBS:BOOL=ON `pwd`/..

make
make install
      </pre>
      </code>
      Again, the path into which you want to install Trilinos in the second to
      last line of the cmake command needs to be adjusted. Obviously, if you
      want to use Trilinos with MPI on parallel machines, you also need to
      flip the value of the <code>TPL_ENABLE_MPI</code> flag above. Finally,
      if your computer has more than one processor core, you may want to add
      the <code>-jN</code> flag to the calls to <code>make</code>
      where <code>N</code> is the number of compile jobs you want to run in
      parallel.
      </p>

      <p>
	Trilinos sometimes searches for other libraries but can't find
	them if they are not in the usual directories or have other
	names. A common example are BLAS or LAPACK. In a case like
	this, you may have to specifically pass the directories and/or
	library names under which they can be found
	to <code>cmake</code>. For example, this may mean to add the
	following flags to the call above:
	<code>
	  <pre>
      -D BLAS_LIBRARY_NAMES:STRING=goto \
      -D BLAS_LIBRARY_DIRS:STRING=/apps/GotoBLAS/lib64 \
      -D LAPACK_LIBRARY_NAMES:STRING=lapack \
      -D LAPACK_LIBRARY_DIRS:STRING=/apps/lapack-3.2.1/lib64
	  </pre>
	</code>
      </p>

      <h3>Configuring for installed Trilinos packages</h3>

      <p>
	The above scheme works if Trilinos is installed in its own directory
	and header and library files are in subdirectories of the directory
	given to <code>--with-trilinos</code>. This scheme doesn't work,
	however, if Trilinos has been installed as a regular package on a
	system, for example into the <code>/usr</code> or <code>/opt</code>
	directories.
      </p>

      <p>
	In that case, paths to include and library files may be specified
	separately using the <code>--with-trilinos-include</code>
	and <code>--with-trilinos-libs</code> switches
	to <code>./configure</code>. Alternatively, this information can also
	be passed to the configuration script by setting the environment
	variables <code>TRILINOS_INCDIR, TRILINOS_LIBDIR</code>.
      </p>

      <h3>Dealing with other Trilinos packages</h3>

      <p>
	In the commands configuring Trilinos shown above, we have assumed a
	particular subset of Trilinos libraries that deal.II interfaces
	with. However, Trilinos has many more packages that deal.II doesn't
	use, and you can add many more <code>-D
	Trilinos_ENABLE_XXX:BOOL=ON</code> flags for
	package <code>XXX</code>. Most of the time, no harm is done by doing
	so, but there are cases where some of the packages deal.II does
	interact with also interacts with package <code>XXX</code> if the
	latter was enabled in Trilinos. One example is that Trilinos' ML
	package (which we use) uses Trilinos' Zoltan package if Zoltan is
	enable, but not if Zoltan is not enabled. That means that
	the <code>libml.so</code> library may or may not depend on
	a <code>libzoltan.so</code> library.
      </p>

      <p>
	Unfortunately, Trilinos' configuration framework does not record this
	in <code>libml.so</code>, and it is also something that is difficult
	for the deal.II configuration framework to find out after the
	fact. Consequently, deal.II's Makefiles rely on the fact
	that <i>only</i> the Trilinos packages listed above were enabled. If
	that isn't the case, you may get linker warnings. The only way to
	solve this problem is to add the additional Trilinos libraries at the
	appropriate place in the list of <code>DEAL_II_TRILINOS_LIBS</code>
	libraries in <code>common/Make.global_options</code> by hand.
      </p>
    <hr>

    <address>
      <a href="mail.html" target="body">The deal.II mailing list</a>
      $Date: 2008-10-14 05:36:48 -0500 (Tue, 14 Oct 2008) $
    </address>
  </body>
</html>
